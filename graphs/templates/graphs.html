{% extends 'base.html' %}
{% block title%}EV and Building Power Consumption{% endblock %}

{% block header %} <h1>Home</h1> {% endblock %}

{% block content %}
<!--Content Here-->
<div class='container'>
    <div class='row'>
        <div class='col-sm-6'>
            <canvas id="myChartEV" width="400" height="400"></canvas>
        </div>
        <div class='col-sm-6'>
            <canvas id="myChartBuilding" width="400" height="400"></canvas>
        </div>
    </div>
</div>

{% endblock %}

<!--Script for our Charts-->
<script>
{% block jquery %}
    var endpoint = '/api/data'
    
    $.ajax({
        method:"GET",
        url: endpoint,
        success: function(data){
            console.log(data)
            //convert our values from JSON string to JSON object
            var result = JSON.parse(data) 
            //Empty arrays to store our values 
            var date = []
            var power = []
            //length (as our objects are in Most recent->least recent)
            var length = result.data.length-1
            for (var x in result.data){
                //slice the ISO-Format String 
                //YYYY-mm-ddTHH:MM:SS.DDDZ -> YYYY-mm-ddTHH:MM
                date.push(result.data[length-x][1].slice(0,16))
                power.push(result.data[length-x][2])
            }
            console.log(date)
            console.log(power)
            //calls our function on success 
            createEVChart(date,power) 
            createBuildingChart(date,power)       
        },
        error: function(err_data){
            console.log("error")
            console.log(err_data)
        }
    });

    /**
     * @param Array x_axis: Array of dates for our chart  
     * @param Array y_axis: Array of power for our chart
     * Returns a chart corresponding to our EV data
     */
    function createEVChart(x_axis,y_axis){
        
        var ctx_ev = document.getElementById("myChartEV").getContext('2d');

        var myChartEV = new Chart(ctx_ev, {
            type: 'line',
            data: {
                labels: x_axis,
                datasets: [{
                    label: 'Power Consumption',
                    data: y_axis,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255,99,132,1)',
                }]
            },
            options: {
                title:{
                    display: true,
                    text: 'EV Charging Stations'
                },
                scales: {
                    xAxes:[{
                        display: true,
                        scaleLabel:{
                            display:true,
                            labelString:'Time'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel:{
                            display: true,
                            labelString: 'Power'
                        },
                        ticks: {
                            beginAtZero:true
                        }
                    }]
                }
            }
        });
    }

     /**
     * @param Array x_axis: Array of dates for our chart  
     * @param Array y_axis: Array of power for our chart
     * Returns a chart corresponding to our Building data
     */
    function createBuildingChart(x_axis,y_axis){
        
        var ctx_building = document.getElementById("myChartBuilding").getContext('2d');

        var myChartBuilding = new Chart(ctx_building, {
            type: 'line',
            data: {
                labels: x_axis, 
                datasets: [{
                    label: 'Power Consumption',
                    data: y_axis,
                    backgroundColor: 'rgba(255, 99, 132, 0)',
                    borderColor: 'rgba(255,99,132,1)',
                }]
            },
            options: {
                title:{
                    display: true,
                    text: 'Building Data'
                },
                scales: {
                    xAxes:[{
                        display: true,
                        scaleLabel:{
                            display:true,
                            labelString:'Time'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel:{
                            display: true,
                            labelString: 'Power'
                        },
                        ticks: {
                            beginAtZero:true
                        }
                    }]
                }
            }
        });
    }
{% endblock %}
</script>