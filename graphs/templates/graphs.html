{% extends 'base.html' %}
{% block title%}EV and Building Power Consumption{% endblock %}

{% block header %} <h1><b>Home</b></h1> {% endblock %}

{% block content %}
<!--Content Here-->
<div class='container'>
    <div class='row'>
        <div class='col-md-12 col-lg-6'>
            <canvas id="myChartEV" width="400" height="400"></canvas>
            <br>
            <div class='row'>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="evdailygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Daily Peak</span>
                        <input type="hidden" id="evdailyval" value={{curr_ev}}>
                        <input type="hidden" id="evdailymax" value={{max_evdaily}}>
                    </div>
                </div>
                <div class="clearfix visible-xs"></div>
                <div class="clearfix visible-sm"></div>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="evmonthlygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Monthly Peak</span>
                        <input type="hidden" id="evmonthlyval" value={{curr_ev}}>
                        <input type="hidden" id="evmonthlymax" value={{max_evmonthly}}>
                    </div>
                </div>
            </div>
        </div>
        <div class="clearfix visible-md"></div>
        <div class='col-md-12 col-lg-6'>
            <canvas id="myChartBuilding" width="400" height="400"></canvas>
            <br>
            <div class='row'>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="bddailygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Daily Peak</span>
                        <input type="hidden" id="bddailyval" value={{curr_bd}}>
                        <input type="hidden" id="bddailymax" value={{max_bddaily}}>
                    </div>
                </div>
                <div class="clearfix visible-xs"></div>
                <div class="clearfix visible-sm"></div>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="bdmonthlygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Monthly Peak</span>
                        <input type="hidden" id="bdmonthlyval" value={{curr_bd}}>
                        <input type="hidden" id="bdmonthlymax" value={{max_bdmonthly}}>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class='row justify-content-center'>
        <div class='col-xs-12 col-sm-12 col-md-8 col-lg-6'>
            <div id="evcontrolgauge" class="gauge-container">
                <span class="large-value-text">kWh</span>
                <span class="large-label">EV Control</span>
                <input type="hidden" id="evcurrval" value={{curr_ev}}>
                <input type="hidden" id="evmaxval" value="40">
            </div>
        </div>
    </div>
    <div class='row justify-content-center'>
        <div class='col-xs-10 col-sm-10 col-md-6 col-lg-4'>
            <input type="range" min="0" max="40" step="0.001" value={{curr_ev}} class="slider" id="TestEV">
        </div>
        <div class='col-xs-2 col-sm-2'>
            <button type="button" class="btn btn-warning">Enter</button>
        </div>
    </div>
</div>
<div class='container'>
    <canvas id="myChartTest" width="400" height="400"></canvas>
</div>
{% endblock %}

<!--Script for our Charts-->
<script>
    {% block jquery %}
    var endpoint = '/api/data'
    var errpoint = '/api/data2'
    var endpoint2 = '/api/data3'

    //Running the ajax methods in parallel
    $.when(
        $.ajax({
            method: "GET",
            url: endpoint
        }),
        $.ajax({
            method: "GET",
            url: errpoint
        }),
        $.ajax({
            method: "GET",
            url: endpoint2
        })
    ).then(function (data1, data2, data3) {
        //data1 currently corresponds to our realtime EV data 
        var result = JSON.parse(data1[0])
        var ev_date = []
        var ev_power = []
        console.log(result)
        //length (as our objects are in Most recent->least recent)
        var length = result.data.length - 1
        for (var x in result.data) {
            //slice the ISO-Format String 
            //YYYY-mm-ddTHH:MM:SS.DDDZ -> YYYY-mm-ddTHH:MM

            // date.push(result.data[length - x][1].slice(0, 16))
            // power.push(result.data[length - x][2])

            ev_date.push(result.data[length - x][0].slice(0, 19))
            ev_power.push(result.data[length - x][1])
        }

        //data3 corresponds to our building data 
        var bd_result = JSON.parse(data3[0])
        var bd_date = []
        var bd_power = []
        console.log(bd_result)
        var bd_length = result.data.length - 1
        for (var x in bd_result.data) {
            bd_date.push(bd_result.data[bd_length - x][0].slice(0, 16))
            bd_power.push(bd_result.data[bd_length - x][1])
        }

        //data2 is the data with error bars 
        var err_result = JSON.parse(data2[0])
        var err_date = []
        var err_power = []
        var max_err = []
        var min_err = []
        var err_length = err_result.data.length - 1
        for (var x in err_result.data) {
            err_date.push(err_result.data[err_length - x][0])
            err_power.push(err_result.data[err_length - x][1])
            max_err.push(err_result.data[err_length - x][2])
            min_err.push(err_result.data[err_length - x][3])
        }        

        //call our chart functions
        var evChart = createChart(ev_date, ev_power, "myChartEV", 'EV Charger Power Data')
        var bdChart = createChart(bd_date, bd_power, "myChartBuilding", 'Building Power Data')
        var testChart = createTestChart(err_date, err_power, max_err, min_err)
        //call our gauge function 
        var evdgauge = createGauge("evdailyval", "evdailymax", "evdailygauge")
        var evmgauge = createGauge("evmonthlyval", "evmonthlymax", "evmonthlygauge")
        var bddgauge = createGauge("bddailyval", "bddailymax", "bddailygauge")
        var bdmgauge = createGauge("bdmonthlyval", "bdmonthlymax", "bdmonthlygauge")

        //Create the control gauge 
        var evctrlgauge = createGauge("evcurrval", "evmaxval", "evcontrolgauge")
        var evslider = document.getElementById("TestEV");

        evslider.oninput = function () {
            evctrlgauge.setValue(this.value)
        }

        // var bdctrlgauge = createGauge("bdcurrval", "bdmaxval", "bdcontrolgauge")
        // var bdslider = document.getElementById("TestBd");

        // bdslider.oninput = function () {
        //     bdctrlgauge.setValue(this.value)
        // }

        console.log(evChart)
        console.log(bdChart)
        console.log(evdgauge)
        //timeout function 
        poll(evChart, evdgauge)

    });
    {% endblock %}
</script>

<script>
    {% block script %}

    function poll(chart_1, gauge_1) {
        /** 
         * Function that calls itself over a set interval using setTimeout and ajax.
         * 
         * @param {Chart} chart_1 Chart object. 
         */ 
        setTimeout(function () {
            $.ajax({
                url: "/api/data",
                type: "GET",
                success: function (data) {
                    console.log("polling next point")
                    var result = JSON.parse(data)
                    console.log(result.data[0][1])
                    //Add most recent datapoint into our chart
                    // addData(chart_1, result.data[0][1].slice(0,16), result.data[0][2])
                    addData(chart_1, result.data[0][0].slice(0,19), result.data[0][1])
                    gauge_1.setValue(result.data[0][1])
                },
                complete: poll(chart_1, gauge_1),
                timeout: 2000
            })
        }, 15*60000);
    }

    function addData(chart, label, datas) {
        /** 
         * Add a new label and datapoint (x,y) to chart object  
         * 
         * @param {Chart} chart Chart object.
         * @param {string} label Our datetime label (x value).
         * @param {double} datas Power value for our label (y value).
         * 
         * Note: This function assumes our chart has only one dataset. 
         *  If there are multiple you must use dataset[0].data. etc. 
         */
        chart.data.labels.splice(0, 1)
        chart.data.labels.push(label);
        chart.data.datasets.forEach((dataset) => {
            dataset.data.splice(0, 1);
            dataset.data.push(datas);
        });
        chart.update();
        console.log("Chart has been updated with ", label, datas)
    }

    function createGauge(val_id, maxval_id, id) {
        /**
         * Creates a Gauge.
         * 
         * @param {double} val_id HTML id where our value gauge is set to. 
         * @param {double} maxval_id HTML id for our Maximum value of gauge.
         * @param {string} id HTML ID for our gauge element.
         * 
         * @return {Gauge} returns Gauge object.
         */

        // Get values 
        var val = document.getElementById(val_id).value
        var max_val = document.getElementById(maxval_id).value
        console.log("Element ", id, "has a val of ", val, "and max value of ", max_val)
        //Gauge Code 
        var gauge = Gauge(
            document.getElementById(id), {
                max: max_val,
                dialStartAngle: 90,
                dialEndAngle: 0,
                value: 0,
                label: function (value) {
                    return Math.round(value * 1000) / 1000;
                } //allows us to have 3 decimal point accuracy 
            }
        );
        // Set value and animate (value, animation duration in seconds)
        gauge.setValueAnimated(val, 3)
        return gauge
    }

    function createChart(x_axis, y_axis, id, label_title) {
        /**
         * Creates a chart for EV Data. 
         * 
         * @param {Array} x_axis Array of dates for our chart. 
         * @param {Array} y_axis Array of power for our chart.
         * @param {string} id HTML element id. 
         * @param {string} label_title Title of the chart.
         *
         * @return {Chart} returns chart object.
         */
        var ctx = document.getElementById(id).getContext('2d');

        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: x_axis,
                datasets: [{
                    label: 'Energy Consumption',
                    data: y_axis,
                    backgroundColor: 'rgba(155, 194, 229, 0.4)',
                    borderColor: '#73C2E5',
                }]
            },
            options: {
                title: {
                    display: true,
                    text: label_title,
                    fontColor: '#0C5784',
                    fontSize: 25,
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Timestamp',
                            fontColor: '#0C5784',
                            fontSize: 20
                        },
                        ticks: {
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Energy (kWh)',
                            fontColor: '#0C5784',
                            fontSize: 20, 
                        },
                        ticks: {
                            beginAtZero: true,
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }],
                },
                legend: {
                    labels: {
                        fontColor: '#0C5784'
                    }
                },
            }
        });

        return myChart
    }

    function createTestChart(x_axis, main, max_err, min_err) {
        /**
         * Creates a chart for with Error Bars.  
         * 
         * @param {Array} x_axis Array of dates for our chart. 
         * @param {Array} main Array of power for our chart.
         * @param {Array} max_err Array of positive error bar for our chart.
         * @param {Array} min_err Array of negative error bar for our chart.
         *
         * @return {Chart} Returns the chart object. 
         */
        var ctx_Test = document.getElementById("myChartTest").getContext('2d');
        var presets = window.chartColors;
        var utils = Samples.utils;

        var myChart = new Chart(ctx_Test, {
            type: 'line',
            data: {
                labels: x_axis,
                datasets: [{
                    label: 'Power Consumption',
                    data: main,
                    backgroundColor: 'rgba(215, 135, 48, 0.4)',
                    borderColor: '#D78730',
                    fill: 'false',
                }, {
                    label: 'Max Power Error',
                    data: max_err,
                    backgroundColor: 'rgba(155, 194, 229, 0.4)',
                    borderColor: '#73C2E5',
                    fill: '-1',
                }, {
                    label: 'Min Power Error',
                    data: min_err,
                    backgroundColor: 'rgba(155, 194, 229, 0.4)',
                    borderColor: '#73C2E5',
                    fill: '-2',
                }]
            },
            options: {
                title: {
                    display: true,
                    text: 'Sample Data',
                    fontColor: '#0C5784',
                    fontSize: 22,
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Time',
                            fontColor: '#0C5784',
                            fontSize: 20,
                        },
                        ticks: {
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Power',
                            fontColor: '#0C5784',
                            fontSize: 20,
                        },
                        ticks: {
                            beginAtZero: true,
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }],
                },
                plugins: {
                    filler: {
                        propagate: true
                    }
                },
                legend: {
                    labels: {
                        fontColor: '#0C5784'
                    }
                },
            }
        });
        return myChart
    }
    {% endblock %}
</script>