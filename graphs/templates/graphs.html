{% extends 'base.html' %}
{% block title%}EV and Building Power Consumption{% endblock %}

{% block header %} <h1><b>Home</b></h1> {% endblock %}

{% block content %}
<!--HTML Content Here-->
<div class='margs'>
    <div class='row'>
        <!--EV Chart-->
        <div class='col-md-12 col-lg-4'>
            <canvas id="myChartEV" width="400" height="400"></canvas>
            <br>
            <div class='row'>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="evdailygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Daily Peak</span>
                        <input type="hidden" id="evdailyval" value={{curr_ev}}>
                        <input type="hidden" id="evdailymax" value={{max_evdaily}}>
                    </div>
                </div>
                <div class="clearfix visible-xs"></div>
                <div class="clearfix visible-sm"></div>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="evmonthlygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Monthly Peak</span>
                        <input type="hidden" id="evmonthlyval" value={{curr_ev}}>
                        <input type="hidden" id="evmonthlymax" value={{max_evmonthly}}>
                    </div>
                </div>
            </div>
        </div>
        <!--Car Chart-->
        <div class="clearfix visible-md"></div>
        <div class='col-md-12 col-lg-4'>
            <canvas id='myChartCar' width='400' height='400'></canvas>
        </div>
        <!--Building Chart-->
        <div class="clearfix visible-md"></div>
        <div class='col-md-12 col-lg-4'>
            <canvas id="myChartBuilding" width="400" height="400"></canvas>
            <br>
            <div class='row'>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="bddailygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Daily Peak</span>
                        <input type="hidden" id="bddailyval" value={{curr_bd}}>
                        <input type="hidden" id="bddailymax" value={{max_bddaily}}>
                    </div>
                </div>
                <div class="clearfix visible-xs"></div>
                <div class="clearfix visible-sm"></div>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="bdmonthlygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Monthly Peak</span>
                        <input type="hidden" id="bdmonthlyval" value={{curr_bd}}>
                        <input type="hidden" id="bdmonthlymax" value={{max_bdmonthly}}>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Control Row / Building + EV Data-->
    <div class='row'>
        <!--Bar Chart-->
        <div class='col-md-12 col-lg-4'>
            <canvas id='myBarChart' width='400' height='400'></canvas>
        </div>
        <!--Building and EV Chart-->
        <div class="clearfix visible-md"></div>
        <div class='col-md-12 col-lg-4'>
            <canvas id="myChartCombo" width="400" height="400"></canvas>
        </div>
        <!--Control Gauge-->
        <div class="clearfix visible-md"></div>
        <div class='col-md-12 col-lg-4'>
            <div id="evcontrolgauge" class="gauge-container">
                <span class="large-value-text">kWh</span>
                <span class="large-label">EV Control</span>
                <input type="hidden" id="evcurrval" value={{curr_ev}}>
                <input type="hidden" id="evmaxval" value="200">
            </div>
            <div class='row justify-content-center'>
                <div class='col-xs-10 col-sm-10 col-md-8 col-lg-8'>
                    <input type="range" min="0" max="200" step="0.001" value={{curr_ev}} class="slider" id="TestEV">
                </div>
                <div class='col-xs-2 col-sm-2'>
                    <button type="button" class="btn btn-warning">Enter</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!--Script for our Charts and Gauges-->
<script>
    {% block jquery %}
    var evpoint = '/api/data'
    var buildingpoint = '/api/data3'
    var vehiclepoint = '/api/cars'
    var evpredictedpoint = 'api/prediction/west'
    var bdpredictedpoint = 'api/prediction/west'

    //Running the ajax methods in parallel
    $.when(
        $.ajax({
            method: "GET",
            url: evpoint
        }),
        $.ajax({
            method: "GET",
            url: buildingpoint
        }),
        $.ajax({
            method: "GET",
            url: vehiclepoint
        }),
        $.ajax({
            method: "GET",
            url: evpredictedpoint
        }),
        $.ajax({
            method: "GET",
            url: bdpredictedpoint
        })
    ).then(function (data_ev, data_building, data_vehicles, data_evprediction, data_bdprediction) {

        //Parse our EV data and format it into arrays 
        var ev_result = JSON.parse(data_ev[0])
        var ev_date = []
        var ev_power = []
        //length (as our objects are in Most recent->least recent)
        var ev_length = ev_result.data.length - 1
        for (var x in ev_result.data) {
            //slice the ISO-Format String 
            //YYYY-mm-ddTHH:MM:SS.DDDZ -> YYYY-mm-ddTHH:MM:SS
            ev_date.push(ev_result.data[ev_length - x][0].slice(0, 16))
            ev_power.push(ev_result.data[ev_length - x][1])
        }

        //Similarly for our building data (static currently)
        var bd_result = JSON.parse(data_building[0])
        var bd_date = []
        var bd_power = []
        var bd_length = bd_result.data.length - 1
        for (var x in bd_result.data) {
            bd_date.push(bd_result.data[bd_length - x][0].slice(0, 16))
            bd_power.push(bd_result.data[bd_length - x][1])
        }

        //create an array for bar chart
        //The array will look like this -> [ev power, building power, combined power]
        var bar_power = []
        bar_power.push(ev_power[ev_power.length-1])
        bar_power.push(bd_power[bd_power.length-1])
        bar_power.push(bar_power[0] + bar_power[1])

        // Our vehicle data (static currently)
        var car_result = JSON.parse(data_vehicles[0])
        var car_date = []
        var car_total = []
        var car_charged = []
        var car_length = car_result.data.length - 1
        for (var x in car_result.data) {
            car_date.push(car_result.data[car_length - x][0].slice(0, 16))
            car_total.push(car_result.data[car_length - x][1])
            car_charged.push(car_result.data[car_length - x][2])
        }

        //Our predicted data for ev
        var predicted_result = JSON.parse(data_evprediction[0])
        var predicted_date = []
        var predicted_val = []
        var predicted_max = []
        var predicted_min = []
        var predicted_length = predicted_result.data.length - 1
        for (var x in predicted_result.data) {
            predicted_date.push((predicted_result.data[predicted_length - x][0]).slice(0, 16))
            predicted_val.push(predicted_result.data[predicted_length - x][1])
            predicted_max.push(predicted_result.data[predicted_length - x][2])
            predicted_min.push(predicted_result.data[predicted_length - x][3])
        }

        // Formatting the ev graph data to include the predicted vals w/ error bars 
        // NOTE: Currently just using static random data for predicted values, change API url once setup
        var evgraph_timestamp = ev_date.slice(0)
        var evgraph_pwr = ev_power.slice(0)
        var evpredicted_pwr = []
        var evpredicted_max = []
        var evpredicted_min = []
        for (var x in ev_date) {
            evpredicted_pwr.push(null)
            evpredicted_max.push(null)
            evpredicted_min.push(null)
        }
        for (var x in predicted_date) {
            evgraph_timestamp.push(predicted_date[x])
            evgraph_pwr.push(null)
            evpredicted_pwr.push(predicted_val[x])
            evpredicted_max.push(predicted_max[x])
            evpredicted_min.push(predicted_min[x])
        }

        // Our predicted results for building 
        // NOTE: Currently just using the same predicted data as ev (some random false data), change the API url once setup
        var predicted_resultbd = JSON.parse(data_bdprediction[0])
        var predicted_datebd = []
        var predicted_valbd = []
        var predicted_maxbd = []
        var predicted_minbd = []
        var predicted_lengthbd = predicted_resultbd.data.length - 1
        for (var x in predicted_resultbd.data) {
            predicted_datebd.push((predicted_resultbd.data[predicted_lengthbd - x][0]).slice(0, 16))
            predicted_valbd.push(predicted_resultbd.data[predicted_lengthbd - x][1])
            predicted_maxbd.push(predicted_resultbd.data[predicted_lengthbd - x][2])
            predicted_minbd.push(predicted_resultbd.data[predicted_lengthbd - x][3])
        }
        // Formatting the building graph data to include the predicted vals w/ error bars 
        var bdgraph_timestamp = bd_date.slice(0)
        var bdgraph_pwr = bd_power.slice(0)
        var bdpredicted_pwr = []
        var bdpredicted_max = []
        var bdpredicted_min = []
        for (var x in bd_date) {
            bdpredicted_pwr.push(null)
            bdpredicted_max.push(null)
            bdpredicted_min.push(null)
        }
        for (var x in predicted_date) {
            bdgraph_timestamp.push(predicted_datebd[x])
            bdgraph_pwr.push(null)
            bdpredicted_pwr.push(predicted_valbd[x])
            bdpredicted_max.push(predicted_maxbd[x])
            bdpredicted_min.push(predicted_minbd[x])
        }

        //call our chart function to create charts 
        //createChart creates our basic chart with predictions 
        var evChart = createChart(evgraph_timestamp, evgraph_pwr, evpredicted_pwr, evpredicted_max, evpredicted_min, "myChartEV", 'EV Charger Power Data', 'Timestamp', 'Power (kW)')
        var bdChart = createChart(bdgraph_timestamp, bdgraph_pwr, bdpredicted_pwr, bdpredicted_max, bdpredicted_min, "myChartBuilding", 'Building Power Data', 'Timestamp', 'Power (kW)')
        //createCarChart creates our vehicle chart 
        var carChart = createCarChart(car_date, car_total, car_charged, "myChartCar", 'Vehicle Data', 'Timestamp', 'Number of Vehicles')
        //createBarChart creates our basic bar chart 
        var barChart = createBarChart(["EV", "Building", "Total"], bar_power, 100, "myBarChart", "Current Power Consumption", "Power (kW)", "Location")
        //createComboChart creates our ev + building chart (assumes we have the same datetime values)
        var testChart = createComboChart1(ev_date, ev_power, bd_power, "myChartCombo", "Power Consumption", "Timestamp", "Power (kW)")


        //call our gauge function to create gauges
        var evdgauge = createGauge("evdailyval", "evdailymax", "evdailygauge")
        var evmgauge = createGauge("evmonthlyval", "evmonthlymax", "evmonthlygauge")
        var bddgauge = createGauge("bddailyval", "bddailymax", "bddailygauge")
        var bdmgauge = createGauge("bdmonthlyval", "bdmonthlymax", "bdmonthlygauge")

        //Create the control gauge for EV power 
        var evctrlgauge = createGauge("evcurrval", "evmaxval", "evcontrolgauge")
        var evslider = document.getElementById("TestEV");

        evslider.oninput = function () {
            evctrlgauge.setValue(this.value)
        }
        //timeout function 
        poll(evChart, bdChart, testChart, barChart, evdgauge, evmgauge, bddgauge, bdmgauge, evpoint, buildingpoint, evpredictedpoint, bdpredictedpoint)

    });
    {% endblock %}
</script>

<script>
    {% block script %}
    function poll(evchart, bdchart, combochart, barchart, ev_gauge1, ev_gauge2, bd_gauge1, bd_gauge2, ev_url, bd_url, evpred_url, bdpred_url) {
        /** 
         * Function that calls itself over a set interval using setTimeout and ajax.
         * Used for EV power. 
         * 
         * @param {Chart} chart Chart object. 
         * @param {Gauge} gauge_1 Gauge Object.
         * @param {Gauge} gauge_2 Gauge Object.  
         */
        setTimeout(function () {
            $.ajax({
                url: ev_url,
                type: "GET",
                success: function (data) {
                    console.log("polling next point")
                    var result = JSON.parse(data)
                    var ev_date = []
                    var ev_power = []
                    //length (as our objects are in Most recent->least recent)
                    var length = result.data.length - 1
                    for (var x in result.data) {
                        //slice the ISO-Format String 
                        //YYYY-mm-ddTHH:MM:SS.DDDZ -> YYYY-mm-ddTHH:MM:SS
                        ev_date.push(result.data[length - x][0].slice(0, 16))
                        ev_power.push(result.data[length - x][1])
                    }
                    //Update our EV gauge and Charts
                    ev_gauge1.setValue(result.data[0][1])
                    ev_gauge2.setValue(result.data[0][1])
                    updateChart(evchart, ev_date, ev_power, evpred_url)

                    //Update our BD Gauge and Charts 
                    var bd_power = updateBuildingData(bdchart, bd_gauge1, bd_gauge2, bd_url, bdpred_url)
                    //Update our Combo Chart
                    updateComboData(combochart, ev_date, ev_power, bd_power)
                    //update our bar graph 
                    var bar_power = []
                    bar_power.push(ev_power[ev_power.length-1])
                    bar_power.push(bd_power[bd_power.length-1])
                    bar_power.push((bar_power[0] + bar_power[1]))
                    updateBarData(barchart, bar_power)
                },
                complete: poll(evchart, bdchart, combochart, barchart, ev_gauge1, ev_gauge2, bd_gauge1, bd_gauge2, ev_url, bd_url, evpred_url, bdpred_url),
                timeout: 2000
            })
        }, 0.5 * 60000); //sleep for 5 mins
    }

    function updateChart(chart, timestamps, pwr, _url) {
        /** 
         * Function that updates our chart. 
         * 
         * @param {Chart} chart Chart object.
         * @param {Array} timestamps Array of dates. 
         * @param {Array} pwr Array of power values. 
         */

        $.ajax({
            url: _url,
            type: "GET",
            success: function (data) {
                var result = JSON.parse(data)
                var predicted_date = []
                var predicted_val = []
                var predicted_max = []
                var predicted_min = []
                var predicted_length = result.data.length - 1
                for (var x in result.data) {
                    predicted_date.push((result.data[predicted_length - x][0]).slice(0, 16))
                    predicted_val.push(result.data[predicted_length - x][1])
                    predicted_max.push(result.data[predicted_length - x][2])
                    predicted_min.push(result.data[predicted_length - x][3])
                }
                //Add most recent datapoint into our chart
                addDataChart(chart, timestamps, pwr, predicted_date, predicted_val, predicted_max, predicted_min)
            },
            error: function (err_data) {
                console.log("error", err_data)
            }
        });
    }

    function updateBuildingData(chart, daily_gauge, monthly_gauge, bd_url, pred_url) {
        /**
         * 
         * 
         */

        var retval = []
        $.ajax({
            url: bd_url,
            type: "GET",
            async: false,
            success: function (data) {
                console.log("polling next building point")
                var result = JSON.parse(data)
                var date = []
                var power = []
                //length (as our objects are in Most recent->least recent)
                var length = result.data.length - 1
                for (var x in result.data) {
                    //slice the ISO-Format String 
                    //YYYY-mm-ddTHH:MM:SS.DDDZ -> YYYY-mm-ddTHH:MM:SS
                    date.push(result.data[length - x][0].slice(0, 16))
                    power.push(result.data[length - x][1])
                }
                //Update our EV gauge and Charts
                daily_gauge.setValue(result.data[0][1])
                monthly_gauge.setValue(result.data[0][1])
                updateChart(chart, date, power, pred_url)
                retval = power.slice(0)
            },
            error: function (err_data) {
                console.log("error", err_data)
            }
        });

        return retval
    }

    function updateComboData(chart, timestamp, ev_pwr, bd_pwr) {
        /**
         * 
         */

        var total_pwr = []
        for (var x in timestamp) {
            total_pwr.push(ev_pwr[x] + bd_pwr[x])
        }
        console.log("updating combo data")
        console.log(timestamp)
        console.log(ev_pwr)
        chart.data.labels = timestamp
        chart.data.datasets[0].data = ev_pwr
        chart.data.datasets[1].data = bd_pwr
        chart.data.datasets[2].data = total_pwr
        chart.update();
    }

    function updateBarData(chart, power){
        chart.data.datasets[0].data = power
        chart.update(); 
        console.log("updating bar data")
    }

    {% endblock %}
</script>