{% extends 'base.html' %}
{% block title%}EV and Building Power Consumption{% endblock %}

{% block header %} <h1><b>Home</b></h1> {% endblock %}

{% block content %}
<!--HTML Content Here-->
<div class='margs'>
    <div class='row'>
        <!--EV Chart-->
        <div class='col-md-12 col-lg-4'>
            <canvas id="myChartEV" width="400" height="400"></canvas>
            <br>
            <div class='row'>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="evdailygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Daily Peak</span>
                        <input type="hidden" id="evdailyval" value={{curr_ev}}>
                        <input type="hidden" id="evdailymax" value={{max_evdaily}}>
                    </div>
                </div>
                <div class="clearfix visible-xs"></div>
                <div class="clearfix visible-sm"></div>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="evmonthlygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Monthly Peak</span>
                        <input type="hidden" id="evmonthlyval" value={{curr_ev}}>
                        <input type="hidden" id="evmonthlymax" value={{max_evmonthly}}>
                    </div>
                </div>
            </div>
        </div>
        <!--Car Chart-->
        <div class="clearfix visible-md"></div>
        <div class='col-md-12 col-lg-4'>
            <canvas id='myChartCar' width='400' height='400'></canvas>
        </div>
        <!--Building Chart-->
        <div class="clearfix visible-md"></div>
        <div class='col-md-12 col-lg-4'>
            <canvas id="myChartBuilding" width="400" height="400"></canvas>
            <br>
            <div class='row'>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="bddailygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Daily Peak</span>
                        <input type="hidden" id="bddailyval" value={{curr_bd}}>
                        <input type="hidden" id="bddailymax" value={{max_bddaily}}>
                    </div>
                </div>
                <div class="clearfix visible-xs"></div>
                <div class="clearfix visible-sm"></div>
                <div class='col-xs-12 col-sm-12 col-md-6 col-lg-6'>
                    <div id="bdmonthlygauge" class="gauge-container">
                        <span class="value-text">kWh</span>
                        <span class="label">Monthly Peak</span>
                        <input type="hidden" id="bdmonthlyval" value={{curr_bd}}>
                        <input type="hidden" id="bdmonthlymax" value={{max_bdmonthly}}>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Control Row / Building + EV Data-->
    <div class='row'>
        <!--Bar Chart-->
        <div class='col-md-12 col-lg-4'>
            <canvas id='myBarChart' width='400' height='400'></canvas>
        </div>
        <!--Building and EV Chart-->
        <div class="clearfix visible-md"></div>
        <div class='col-md-12 col-lg-4'>
            <canvas id="myChartTest" width="400" height="400"></canvas>
        </div>
        <!--Control Gauge-->
        <div class="clearfix visible-md"></div>
        <div class='col-md-12 col-lg-4'>
            <div id="evcontrolgauge" class="gauge-container">
                <span class="large-value-text">kWh</span>
                <span class="large-label">EV Control</span>
                <input type="hidden" id="evcurrval" value={{curr_ev}}>
                <input type="hidden" id="evmaxval" value="200">
            </div>
            <div class='row justify-content-center'>
                <div class='col-xs-10 col-sm-10 col-md-8 col-lg-8'>
                    <input type="range" min="0" max="200" step="0.001" value={{curr_ev}} class="slider" id="TestEV">
                </div>
                <div class='col-xs-2 col-sm-2'>
                    <button type="button" class="btn btn-warning">Enter</button>
                </div>
            </div>
        </div>
    </div>
    <div class='row'>
        <canvas id='myNewChart'></canvas>
    </div>
</div>
{% endblock %}

<!--Script for our Charts and Gauges-->
<script>
    {% block jquery %}
    var endpoint = '/api/data'
    var errpoint = '/api/data2'
    var endpoint2 = '/api/data3'
    var carendpoint = '/api/cars'
    var futurepoint = 'api/prediction/west'

    //Running the ajax methods in parallel
    $.when(
        $.ajax({
            method: "GET",
            url: endpoint
        }),
        $.ajax({
            method: "GET",
            url: errpoint
        }),
        $.ajax({
            method: "GET",
            url: endpoint2
        }),
        $.ajax({
            method: "GET",
            url: carendpoint
        }),
        $.ajax({
            method: "GET",
            url: futurepoint
        })
    ).then(function (data1, data2, data3, data4, data5) {
        //data1 currently corresponds to our realtime EV data 
        var result = JSON.parse(data1[0])
        var ev_date = []
        var ev_power = []
        var bar_power = []
        //length (as our objects are in Most recent->least recent)
        var length = result.data.length - 1
        for (var x in result.data) {
            //slice the ISO-Format String 
            //YYYY-mm-ddTHH:MM:SS.DDDZ -> YYYY-mm-ddTHH:MM:SS
            ev_date.push(result.data[length - x][0].slice(0, 16))
            ev_power.push(result.data[length - x][1])
        }

        //data3 corresponds to our building data (static data currently)
        var bd_result = JSON.parse(data3[0])
        var bd_date = []
        var bd_power = []
        var bd_length = bd_result.data.length - 1
        for (var x in bd_result.data) {
            bd_date.push(bd_result.data[bd_length - x][0].slice(0, 16))
            bd_power.push(bd_result.data[bd_length - x][1])
        }

        //create an array for bar chart
        bar_power.push(ev_power[length])
        bar_power.push(bd_power[bd_length])
        bar_power.push((ev_power[length] + bd_power[bd_length]))

        //data2 is the data with error bars (static data currently)
        var err_result = JSON.parse(data2[0])
        var err_date = []
        var err_power = []
        var max_err = []
        var min_err = []
        var err_length = err_result.data.length - 1
        for (var x in err_result.data) {
            err_date.push(err_result.data[err_length - x][0])
            err_power.push(err_result.data[err_length - x][1])
            max_err.push(err_result.data[err_length - x][2])
            min_err.push(err_result.data[err_length - x][3])
        }

        //data4 corresponds to our car data (static currently)
        var car_result = JSON.parse(data4[0])
        var car_date = []
        var car_total = []
        var car_charged = []
        var car_length = car_result.data.length - 1
        for (var x in car_result.data) {
            car_date.push(car_result.data[car_length - x][0].slice(0, 16))
            car_total.push(car_result.data[car_length - x][1])
            car_charged.push(car_result.data[car_length - x][2])
        }

        //data5 corresponds to our west future ev values (static prediction currently)
        var predicted_result = JSON.parse(data5[0])
        var predicted_date = []
        var predicted_val = []
        var predicted_max = []
        var predicted_min = []
        var predicted_length = predicted_result.data.length - 1
        for (var x in predicted_result.data) {
            predicted_date.push((predicted_result.data[predicted_length - x][0]).slice(0, 16))
            predicted_val.push(predicted_result.data[predicted_length - x][1])
            predicted_max.push(predicted_result.data[predicted_length - x][2])
            predicted_min.push(predicted_result.data[predicted_length - x][3])
        }

        //variable for newtestdates
        var newtestdates = []
        var newev_vals = ev_power
        var newpredicted_vals = []
        var newpredicted_max = []
        var newpredicted_min = []
        for (var x in ev_date) {
            newtestdates.push(ev_date[x])
            newpredicted_vals.push(null)
            newpredicted_max.push(null)
            newpredicted_min.push(null)
        }
        for (var x in predicted_date) {
            newtestdates.push(predicted_date[x])
            newev_vals.push(null)
            newpredicted_vals.push(predicted_val[x])
            newpredicted_max.push(predicted_max[x])
            newpredicted_min.push(predicted_min[x])

        }

        //call our chart function to create charts 
        var evChart = createChart(ev_date, ev_power, "myChartEV", 'EV Charger Power Data')
        var bdChart = createChart(bd_date, bd_power, "myChartBuilding", 'Building Power Data')
        var testChart = createTestChart("myChartTest", err_date, err_power, max_err, min_err)
        var carChart = createCarChart("myChartCar", car_date, car_total, car_charged)
        var barChart = createBarChart("myBarChart", ["EV", "Building", "Total"], bar_power, 100)
        var newChart = createNewChart(newtestdates, newev_vals, newpredicted_vals, newpredicted_max, newpredicted_min, "myNewChart", "Test Chart", "Timestamp", "Power (kW)")

        //call our gauge function to create gauges
        var evdgauge = createGauge("evdailyval", "evdailymax", "evdailygauge")
        var evmgauge = createGauge("evmonthlyval", "evmonthlymax", "evmonthlygauge")
        var bddgauge = createGauge("bddailyval", "bddailymax", "bddailygauge")
        var bdmgauge = createGauge("bdmonthlyval", "bdmonthlymax", "bdmonthlygauge")

        //Create the control gauge for EV power 
        var evctrlgauge = createGauge("evcurrval", "evmaxval", "evcontrolgauge")
        var evslider = document.getElementById("TestEV");

        evslider.oninput = function () {
            evctrlgauge.setValue(this.value)
        }
        //timeout function 
        console.log(newChart)
        evpoll(evChart, newChart, evdgauge, evmgauge)

    });
    {% endblock %}
</script>

<script>
    {% block script %}

    function evpoll(chart_1, chart_2, gauge_1, gauge_2) {
        /** 
         * Function that calls itself over a set interval using setTimeout and ajax.
         * Used for EV power. 
         * 
         * @param {Chart} chart_1 Chart object. 
         * @param {Gauge} gauge_1 Gauge Object. 
         */
        setTimeout(function () {
            $.ajax({
                url: "/api/data",
                type: "GET",
                success: function (data) {
                    console.log("polling next point")
                    var result = JSON.parse(data)
                    var ev_date = []
                    var ev_power = []
                    //length (as our objects are in Most recent->least recent)
                    var length = result.data.length - 1
                    for (var x in result.data) {
                        //slice the ISO-Format String 
                        //YYYY-mm-ddTHH:MM:SS.DDDZ -> YYYY-mm-ddTHH:MM:SS
                        ev_date.push(result.data[length - x][0].slice(0, 16))
                        ev_power.push(result.data[length - x][1])
                    }
                    //Add most recent datapoint into our chart
                    // addData(chart_1, result.data[0][1].slice(0,16), result.data[0][2])
                    // testData(chart_1, chart_2, ev_date, ev_power)
                    gauge_1.setValue(result.data[0][1])
                    gauge_2.setValue(result.data[0][1])
                    nextpoll(chart_1, chart_2, gauge_1, gauge_2, ev_date, ev_power)
                },
                complete: evpoll(chart_1, chart_2, gauge_1, gauge_2),
                timeout: 2000
            })
        }, 0.3 * 60000);
    }

    function nextpoll(chart_1, chart_2, gauge_1, gauge_2, ev_timestamps, ev_pwrval) {
        /** 
         * Function that calls itself over a set interval using setTimeout and ajax.
         * Used for EV power. 
         * 
         * @param {Chart} chart_1 Chart object. 
         * @param {Gauge} gauge_1 Gauge Object. 
         */

        $.ajax({
            url: "/api/prediction/west",
            type: "GET",
            success: function (data) {
                var result = JSON.parse(data)
                var predicted_date = []
                var predicted_val = []
                var predicted_max = []
                var predicted_min = []
                var predicted_length = result.data.length - 1
                for (var x in result.data) {
                    predicted_date.push((result.data[predicted_length - x][0]).slice(0, 16))
                    predicted_val.push(result.data[predicted_length - x][1])
                    predicted_max.push(result.data[predicted_length - x][2])
                    predicted_min.push(result.data[predicted_length - x][3])
                }
                //Add most recent datapoint into our chart
                // addData(chart_1, result.data[0][1].slice(0,16), result.data[0][2])
                addDataChart(chart_2, ev_timestamps, ev_pwrval, predicted_date, predicted_val, predicted_max, predicted_min)
            },
            error: function(err_data){
                console.log("error", err_data)
            }
        });
    }



    function addDataChart(chart_2, ev_x, ev_y, pred_x, pred_y, pred_max, pred_min) {
        /**
         * 
         */
        var timestamp = ev_x
        var evpwr = ev_y
        var predictedpwr = []
        var predictedmax = []
        var predictedmin = []
        for (var x in ev_x) {
            predictedpwr.push(null)
            predictedmax.push(null)
            predictedmin.push(null)
        }
        for (var x in pred_x) {
            timestamp.push(pred_x[x])
            evpwr.push(null)
            predictedpwr.push(pred_y[x])
            predictedmax.push(pred_max[x])
            predictedmin.push(pred_min[x])
        }

        console.log(evpwr)
        console.log(predictedpwr)
        console.log(predictedmax)
        console.log(predictedmin)
        console.log(timestamp)
        chart_2.data.datasets[0].data = evpwr
        chart_2.data.datasets[1].data = predictedpwr
        chart_2.data.datasets[2].data = predictedmax
        chart_2.data.datasets[3].data = predictedmin
        chart_2.data.labels = timestamp 
        chart_2.update();
        console.log("chart 2 updated")
    }
    function testData(chart, chart2, x_arr, y_arr) {
        /** 
         * Add a new label and datapoint (x,y) to chart object  
         * 
         * @param {Chart} chart Chart object.
         * @param {string} label Our datetime label (x value).
         * @param {double} datas Power value for our label (y value).
         * 
         * Note: This function assumes our chart has only one dataset. 
         *  If there are multiple you must use dataset[0].data. etc. 
         */

        chart2.data.datasets[0].data = y_arr
        var x = 0
        while (x < 44) {
            chart2.data.datasets[0].data.push(null)
        }
        chart2.update();
        console.log("chart 2 is updated")
    }

    function checknewData(chart, label) {
        /**
         * Checks the Chart to see if the new label is a new point or not. 
         * 
         * @param {Chart} chart Chart object. 
         * @param {string} label Our datetime label. 
         * 
         * @return {Boolean} returns True if we have a new point, false otherwise. 
         */

        var index = chart.data.labels.length
        var last_label = chart.data.labels[index - 1]

        console.log(last_label)
        console.log(label)

        if (last_label == label) {
            console.log("no update")
            return false
        }

        return true
    }
    /*--------------------------------------Will figure out this function once we get Real Time Building data-------------------------------------------------------*/
    // function bdpoll(chart_1, gauge_1) {
    //     /** 
    //      * Function that calls itself over a set interval using setTimeout and ajax. 
    //      * Used for Building Power
    //      * 
    //      * @param {Chart} chart_1 Chart object. 
    //      * @param {Gauge} gauge_1 Gauge object. 
    //      */ 
    //     setTimeout(function () {
    //         $.ajax({
    //             url: "/api/data3",
    //             type: "GET",
    //             success: function (data) {
    //                 console.log("polling next point")
    //                 var result = JSON.parse(data)
    //                 console.log(result.data[0][1])
    //                 //Add most recent datapoint into our chart
    //                 addData(chart_1, result.data[0][0].slice(0,16), result.data[0][1])
    //                 gauge_1.setValue(result.data[0][1])
    //             },
    //             complete: evpoll(chart_1, gauge_1),
    //             timeout: 2000
    //         })
    //     }, 15*60000);
    // }

    function createCarChart(id, x_axis, totalcars, chargedcars) {
        /**
         * Creates a chart for number of cars.
         * 
         * @param {string} id string of element ID in HTML.
         * @param {Array} x_axis Array of dates for our chart. 
         * @param {Array} totalcars Array of total cars within the EV parkade. 
         * @param {Array} chargedcars Array of cars that are done charginh in EV parkade. 
         * 
         * @return {Chart} Returns chart object 
         */
        var ctx = document.getElementById(id).getContext('2d');

        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: x_axis,
                datasets: [{
                    label: 'Total Connected Vehicles',
                    data: totalcars,
                    backgroundColor: 'rgba(215, 135, 48, 0.4)',
                    borderColor: '#D78730',
                    fill: '1',
                    stepped: true,
                }, {
                    label: 'Charged Vehicles',
                    data: chargedcars,
                    backgroundColor: 'rgba(155, 194, 229, 0.4)',
                    borderColor: '#73C2E5',
                    stepped: true,
                }]
            },
            options: {
                title: {
                    display: true,
                    text: 'Vehicle Data',
                    fontColor: '#0C5784',
                    fontSize: 22,
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Timestamp',
                            fontColor: '#0C5784',
                            fontSize: 20,
                        },
                        ticks: {
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Number of Vehicles',
                            fontColor: '#0C5784',
                            fontSize: 20,
                        },
                        ticks: {
                            beginAtZero: true,
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }],
                },
                plugins: {
                    filler: {
                        propagate: true
                    }
                },
                legend: {
                    labels: {
                        fontColor: '#0C5784'
                    }
                },
            }
        });
        return myChart
    }

    function createBarChart(id, x_axis, values, powercap) {
        /**
         * Creates a chart for number of cars.
         * 
         * @param {string} id string of element ID in HTML.
         * @param {Array} x_axis Array of dates for our chart. 
         * @param {Array} values Array of vals for our bar chart 
         * @param {double} powercap Double val that represents the max power we want to avoid.
         * 
         * @return {Chart} Returns chart object 
         */
        var ctx = document.getElementById(id).getContext('2d');

        var pwrcap = []
        for (var x in x_axis) {
            pwrcap.push(powercap)
        }

        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: x_axis,
                datasets: [{
                    label: 'EV Power Consumption',
                    data: values,
                    backgroundColor: [
                        'rgba(155, 194, 229, 0.4)',
                        'rgba(215, 135, 48, 0.4)',
                        'rgba(91, 122, 139, 0.4)',
                    ],
                    borderColor: [
                        '#73C2E5',
                        '#D78730',
                        '#5B7A8B'
                    ],
                    borderWidth: 3
                }, {
                    type: 'line',
                    label: 'Power Cap',
                    data: pwrcap,
                    backgroundColor: 'rgba(48, 48, 52, 0.4)',
                    borderColor: '#303034',
                    borderWidth: 4,
                    fill: 'false'
                }],
            },
            options: {
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Location',
                            fontColor: '#0C5784',
                            fontSize: 20,
                        },
                        ticks: {
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Power (kW)',
                            fontColor: '#0C5784',
                            fontSize: 20,
                        },
                        ticks: {
                            beginAtZero: true,
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }]
                }
            },
            legend: {
                labels: {
                    fontColor: '#0C5784',
                }
            },
        })
        return myChart
    }

    function createNewChart(dates, pwr_vals, future_pwr, maxerr_pwr, minerr_pwr, id, lbl_title, x_axis, y_axis) {
        /**
         * Creates a chart for EV Data. 
         * 
         * @param {Array} dates Array of dates for our chart. 
         * @param {Array} pwr_vals Array of power for our chart.
         * @param {Array} future_pwr Array of future values for our chart. 
         * @param {Array} maxerr_pwr Array of max error for future values.
         * @param {Array} minerr_pwr Array of min error for future values.
         * @param {string} id HTML element id. 
         * @param {string} lbl_title Title of the chart.
         * @param {string} x_axis Title for x-axis of the chart.
         * @param {string} y_axis Title for y-axis of the chart. 
         *
         * @return {Chart} returns chart object.
         */
        var ctx = document.getElementById(id).getContext('2d');


        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'EV Consumption',
                    data: pwr_vals,
                    spanGaps: false,
                    backgroundColor: 'rgba(155, 194, 229, 0.4)',
                    borderColor: '#73C2E5',
                }, {
                    label: 'Predicted Consumption',
                    data: future_pwr,
                    spanGaps: false,
                    backgroundColor: 'rgba(155, 194, 229, 0.4)',
                    borderColor: '#73C2E5',
                    fill: false,
                    borderDash: [10, 10]
                }, {
                    label: 'Max',
                    data: maxerr_pwr,
                    spanGaps: false,
                    backgroundColor: 'rgba(215, 135, 48, 0.4)',
                    borderColor: '#D78730',
                    borderWidth: 1,
                    fill: '-1',
                    pointRadius: 0,
                }, {
                    label: 'Min',
                    data: minerr_pwr,
                    spanGaps: false,
                    backgroundColor: 'rgba(215, 135, 48, 0.4)',
                    borderColor: '#D78730',
                    borderWidth: 1,
                    fill: '-2',
                    pointRadius: 0,
                }]
            },
            options: {
                title: {
                    display: true,
                    text: lbl_title,
                    fontColor: '#0C5784',
                    fontSize: 25,
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: x_axis,
                            fontColor: '#0C5784',
                            fontSize: 20
                        },
                        ticks: {
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: y_axis,
                            fontColor: '#0C5784',
                            fontSize: 20,
                        },
                        ticks: {
                            beginAtZero: true,
                            fontColor: '#0C5784'
                        },
                        gridLines: {
                            color: '#0C5784',
                            display: true
                        }
                    }],
                },
                legend: {
                    labels: {
                        fontColor: '#0C5784'
                    }
                },
            }
        });
        return myChart
    }

    {% endblock %}
</script>